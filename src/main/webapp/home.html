<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SCUT CINEMA</title>
    <!-- load stylesheets -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700">
    <!-- Google web font "Open Sans" -->
    <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">                <!-- Font Awesome -->
    <link rel="stylesheet" href="css/bootstrap.min.css">                                      <!-- Bootstrap style -->
    <link rel="stylesheet" type="text/css" href="css/datepicker.css"/>
    <link rel="stylesheet" type="text/css" href="slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="slick/slick-theme.css"/>
    <link rel="stylesheet" href="css/templatemo-style.css">                                   <!-- Templatemo style -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div class="tm-main-content" id="top">
    <div class="tm-top-bar-bg"></div>
    <div class="tm-top-bar" id="tm-top-bar">
        <div class="container">
            <div class="row">
                <nav class="navbar navbar-expand-lg narbar-light">
                    <a class="navbar-brand mr-auto" href="#">
                        <img src="img/logo.png" alt="Site logo">
                        Scut Cinema
                    </a>
                    <button type="button" id="nav-toggle" class="navbar-toggler collapsed" data-toggle="collapse"
                            data-target="#mainNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div id="mainNav" class="collapse navbar-collapse tm-bg-white">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link active" href="#top">Home <span class="sr-only">(current)</span></a>

                            <li class="nav-item">
                                <a class="nav-link" href="#tm-section-3">Films</a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div> <!-- row -->
        </div> <!-- container -->
    </div> <!-- .tm-top-bar -->
    <div class="tm-page-wrap mx-auto">
        <section class="tm-banner">
            <div class="tm-container-outer tm-banner-bg">
                <div class="container">
                    <div class="row tm-banner-row tm-banner-row-header">
                        <div class="col-xs-12">
                            <div class="tm-banner-header">
                                <h1 class="text-uppercase tm-banner-title">Let's begin</h1>
                                <img src="img/dots-3.png" alt="Dots">
                                <p class="tm-banner-subtitle">Just enjoy it!</p>
                                <a href="javascript:void(0)" class="tm-down-arrow-link"><i
                                        class="fa fa-2x fa-angle-down tm-down-arrow"></i></a>
                            </div>
                        </div>  <!-- col-xs-12 -->
                    </div> <!-- row -->
                    <div class="row tm-banner-row" id="tm-section-search">

                        <div class="tm-search-form tm-section-pad-2">
                            <div class="form-row tm-search-form-row">
                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-1">
                                    <label for="inputCity">Selected Film </label>
                                    <input name="destination" type="text" class="form-control selected-film"
                                           id="inputCity"
                                           placeholder="Please chose a film first!" disabled="disabled">
                                </div>

                            </div> <!-- form-row -->
                            <div class="form-row tm-search-form-row">
                                <div class="form-group tm-form-group tm-form-group-1">
                                    <div class="form-group tm-form-group tm-form-group-pad tm-form-group-3">
                                        <label for="inputAdult">Seat Row</label>
                                        <select name="row" class="form-control tm-select" id="seat-row">
                                            <option value="1" selected>1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </div>
                                    <div class="form-group tm-form-group tm-form-group-pad tm-form-group-3">

                                        <label for="inputChildren">Seat Column</label>
                                        <select name="column" class="form-control tm-select" id="seat-column">
                                            <option value="1" selected>1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row tm-search-form-row">
                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-1">
                                    <label for="btnSubmit">&nbsp;</label>
                                    <button type="submit"
                                            class="btn btn-primary tm-btn tm-btn-search text-uppercase"
                                            id="addBtn">ADD SEAT NUMBER
                                    </button>
                                </div>
                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-1">
                                    <label for="btnSubmit">&nbsp;</label>
                                    <button type="submit"
                                            class="btn btn-primary tm-btn tm-btn-search text-uppercase"
                                            id="removeBtn">RRMOVE SEAT NUMBER
                                    </button>
                                </div>
                            </div>
                            <div class="form-row tm-search-form-row">

                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-3">
                                    <label for="inputCheckIn">Selected Seat Number</label>
                                    <input name="destination" type="text" class="form-control selected-seat"
                                           disabled="disabled">
                                </div>

                                <!-- 选择时间段 -->
                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-2">
                                    <label for="inputRoom">Select Period</label>
                                    <select name="room" class="form-control tm-select" id="select-period">
                                    </select>
                                </div>

                                <div class="form-group tm-form-group tm-form-group-pad tm-form-group-1">
                                    <label for="btnSubmit">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary tm-btn tm-btn-search text-uppercase"
                                            id="SubmitOrderBtn">Submit
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div> <!-- row -->
                    <div class="tm-banner-overlay"></div>
                </div>  <!-- .container -->
            </div>     <!-- .tm-container-outer -->
        </section>
        <div class="tm-container-outer" id="tm-section-3">
            <ul class="nav nav-pills tm-tabs-links">
                <li class="tm-tab-link-li">
                    <a href="#1a" data-toggle="tab" class="tm-tab-link" id="filmsBtn">
                        <img src="img/north-america.png" alt="Image" class="img-fluid">
                        Popular Films
                    </a>
                </li>
                <li class="tm-tab-link-li">
                    <a href="#1a" data-toggle="tab" class="tm-tab-link " id="orderBtn">
                        <img src="img/south-america.png" alt="Image" class="img-fluid">
                        My booking Order
                    </a>
                </li>
            </ul>
            <div class="tlinks">Collect from <a href="http://www.cssmoban.com/">网页模板</a></div>
            <div class="tab-content clearfix">
                <!-- Tab 1 -->
                <div class="tab-pane fade" id="1a"></div>

            </div> <!-- tab-pane -->

        </div>
        <footer class="tm-container-outer">
            <p class="mb-0">Copyright © <span class="tm-current-year">2018</span> Honda Liang UML Lib4

                . Designed by <a rel="nofollow" href="#" target="_parent">Template Mo</a></p>
            <p>More Templates <a href="http://www.cssmoban.com/" target="_blank" title="模板之家">模板之家</a> - Collect from <a
                    href="http://www.cssmoban.com/" title="网页模板" target="_blank">网页模板</a></p>
        </footer>
    </div>
</div>

<!-- 电影信息模板 -->
<script type="text/template" id="filmListTemplate">
    {{#data}}
    <div class="tm-recommended-place-wrap">
        <div class="tm-recommended-place">
            <img src="img/tm-img-06.jpg" alt="Image" class="img-fluid tm-recommended-img">
            <div class="tm-recommended-description-box">
                <h3 class="tm-recommended-title">{{name}}</h3>
                <p class="tm-text-highlight">导演 : {{director}}</p>
                <p class="tm-text-highlight">演员 : {{actors}}</p>
                <p class="tm-text-highlight">时长 : {{last_len}}分钟</p>
                <p class="tm-text-highlight">类型 : {{type}}</p>
                <p class="tm-text-gray">{{introduction}}</p>
            </div>
            <a href="#" class="tm-recommended-price-box select" data-fid="{{fid}}" data-name="{{name}}">
                <p class="tm-recommended-price">{{price}}￥</p>
                <p class="tm-recommended-price-link">SELECT</p>
            </a>
        </div>
    </div>
    {{/data}}
</script>

<!-- 预定订单模板 -->
<script type="text/template" id="OrderListTemplate">
    {{#data}}
    <div class="tm-recommended-place-wrap">
        <div class="tm-recommended-place">
            <img src="img/tm-img-06.jpg" alt="Image" class="img-fluid tm-recommended-img">
            <div class="tm-recommended-description-box">
                <h3 class="tm-recommended-title">{{FilmAndPeriod.name}}</h3>
                <p class="tm-text-highlight">导演 : {{FilmAndPeriod.director}}</p>
                <p class="tm-text-highlight">演员 : {{FilmAndPeriod.actors}}</p>
                <p class="tm-text-highlight">时长 : {{FilmAndPeriod.last_len}}分钟</p>
                <p class="tm-text-highlight">类型 : {{FilmAndPeriod.type}}</p>
                <p class="tm-text-highlight">时间 : {{FilmAndPeriod.start_time}}</p>
                <p class="tm-text-highlight">座位号 : {{seatNumber}}</p>
                <p class="tm-text-gray">{{FilmAndPeriod.introduction}}</p>
            </div>
            <a  class="tm-recommended-price-box select">
                <p class="tm-recommended-price">{{FilmAndPeriod.price}}￥</p>
            </a>
        </div>
    </div>
    {{/data}}
</script>

<!-- 选择事件段模板 -->
<script type="text/template" id="periodTemplate">
    {{#data.period}}
    <option value="{{pid}}" selected>开始时间 : {{start_time}}, 放映厅 : {{video_hall}}号</option>
    {{/data.period}}
</script>


<!-- load JS files -->
<script src="js/jquery-1.11.3.min.js"></script>             <!-- jQuery (https://jquery.com/download/) -->
<script src="js/popper.min.js"></script>                    <!-- https://popper.js.org/ -->
<script src="js/bootstrap.min.js"></script>                 <!-- https://getbootstrap.com/ -->
<script src="js/datepicker.min.js"></script>                <!-- https://github.com/qodesmith/datepicker -->
<script src="js/jquery.singlePageNav.min.js"></script>
<!-- Single Page Nav (https://github.com/ChrisWojcik/single-page-nav) -->
<script src="slick/slick.min.js"></script>                  <!-- http://kenwheeler.github.io/slick/ -->
<script src="js/jquery.scrollTo.min.js"></script>           <!-- https://github.com/flesler/jquery.scrollTo -->
<script src="js/handlebars-v4.0.11.js"></script>    <!-- 前端渲染 -->
<script>
    /* DOM is ready
    ------------------------------------------------*/
    $(document).ready(function () {

        // 网页样式部分
        // Change top navbar on scroll
        $(window).on("scroll", function () {
            if ($(window).scrollTop() > 100) {
                $(".tm-top-bar").addClass("active");
            } else {
                $(".tm-top-bar").removeClass("active");
            }
        });

        // Smooth scroll to search form
        $('.tm-down-arrow-link').click(function () {
            $.scrollTo('#tm-section-search', 300, {easing: 'linear'});
        });

        // Update nav links on scroll
        $('#tm-top-bar').singlePageNav({
            currentClass: 'active',
            offset: 60
        });

        // Close navbar after clicked
        $('.nav-link').click(function () {
            $('#mainNav').removeClass('show');
        });

        // Slick Carousel
        $('.tm-slideshow').slick({
            infinite: true,
            arrows: true,
            slidesToShow: 1,
            slidesToScroll: 1
        });


        $('.tm-current-year').text(new Date().getFullYear());  // Update year in copyright

        // 前后端交互部分
        // 点击Popular Films获取后台的所有电影信息，然后进行渲染

        $.getSeatNum = function () {
            // 得到选择的行和列
            let rowNum = parseInt($('#seat-row').val());
            let columnNum = parseInt($('#seat-column').val());
            // 计算得出座位号
            let num = (rowNum-1)*8 + columnNum;
            return num;
        };

        $.showSelectedSeat = function (seat_number) {
            $('.selected-seat').val(seat_number);
        }

        $('#filmsBtn').click(function () {
            // 加载所有电影
            $.ajax({
                url: '/film/list',
                type: 'GET',
                async: false,
                contentType: "application/json",
                dataType: 'json',
                success: function (data) {
                    console.log("get response : " + data['status'] + " " + data["data"][0].fid + " " + data["data"].length);
                    let tpl = $("#filmListTemplate").html();
                    // 预编译模板
                    let template = Handlebars.compile(tpl);
                    // 匹配json内容
                    let html = template(data);
                    // 插入模板,到ul中
                    $('#1a').html(html);
                    // 为每一个选择按钮绑定点击事件
                    let btns = document.querySelectorAll('a.select');
                    for(let btn of btns) {
                        let filmName = btn.dataset.name; // 电影名称
                        let fid = btn.dataset.fid;
                        btn.addEventListener('click',function () {
                            $('.selected-film').val(filmName);
                            // 获得某一个电影的具体场次
                            let url = '/film/' + fid;
                            $.ajax({
                                url:url,
                                type:'GET',
                                async:false,
                                dataType:'json',
                                success:function(data){
                                    console.log("get response : " + data);
                                    let tpl = $("#periodTemplate").html();
                                    //预编译模板
                                    let template = Handlebars.compile(tpl);
                                    //匹配json内容
                                    let html = template(data);
                                    //插入模板,到ul中
                                    $('#select-period').html(html);
                                }
                            });
                        });
                    };
                    let seat_number = new Array(); // 选择的座位号
                    // 增加座位按钮的事件
                    $('#addBtn').click(function () {
                        let num = $.getSeatNum();
                        for (let i of  seat_number)
                            if (i == num) return;
                        seat_number.push(num);
                        console.log(seat_number);
                        $.showSelectedSeat(seat_number);
                    });
                    // 删除座位按钮事件
                    $('#removeBtn').click(function () {
                        let num = $.getSeatNum();
                        seat_number.pop(num);
                        console.log(seat_number);
                        $.showSelectedSeat(seat_number);
                    })
                    // 生成订单
                    $("#SubmitOrderBtn").click(function () {
                        let pid = $('#select-period').val();
                        let send = {pid : pid, seat_number : seat_number};
                        $.ajax({
                            url:'/film/order',
                            type:'POST',
                            async:false,
                            data: JSON.stringify(send),
                            contentType : "application/json",
                            dataType:'json',
                            success:function(data){
                                if (data.status == false){
                                    alert(data.message);
                                } else alert("生成订单成功");
                            }
                        });
                    });
                }
            });
        })

        // 查看个人的所有订单
        $("#orderBtn").click(function(){
            $.ajax({
                url:'/film/orders',
                type:'GET',
                async:false,
                dataType:'json',
                success:function(data){
                    console.log("get response : " + data);
                    let tpl = $("#OrderListTemplate").html();
                    // 预编译模板
                    let template = Handlebars.compile(tpl);
                    // 匹配json内容
                    let html = template(data);
                    // 插入模板,到ul中
                    $('#1a').html(html);
                }
            });
        });

    });

</script>

</body>
</html>